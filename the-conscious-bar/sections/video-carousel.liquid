{% schema %}
{
  "name": "Video Carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Featured Videos"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 5
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#f5f0e8"
    },
    {
      "type": "checkbox",
      "id": "use_metafields",
      "label": "Use Product Metafield Videos",
      "default": false,
      "info": "Enable to show videos from product metafields (video_1 to video_5)"
    }
  ],
  "blocks": [
    {
      "type": "video",
      "name": "Video",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Video"
        },
        {
          "type": "text",
          "id": "username",
          "label": "Username",
          "default": "@username"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Featured product",
          "info": "Product to display on center video only"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Video Carousel",
      "blocks": [
        { "type": "video" },
        { "type": "video" },
        { "type": "video" },
        { "type": "video" },
        { "type": "video" }
      ]
    }
  ]
}
{% endschema %}

{% comment %} Check if there are any videos to display {% endcomment %}
{% assign has_videos = false %}

{% comment %} Check blocks for videos {% endcomment %}
{% for block in section.blocks %}
  {% if block.settings.video %}
    {% assign has_videos = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% comment %} Check metafields for videos if enabled {% endcomment %}
{% if section.settings.use_metafields and product %}
  {% for i in (1..5) %}
    {% assign video_key = 'video_' | append: i %}
    {% assign metafield_video = product.metafields.custom[video_key] %}
    {% if metafield_video != blank %}
      {% assign has_videos = true %}
      {% break %}
    {% endif %}
  {% endfor %}
{% endif %}

{% if has_videos %}
  <style>
    .video-carousel-section {
      padding: 60px 0;
      background-color: {{ section.settings.bg_color }};
      overflow: hidden;
    }
    .video-carousel-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .video-carousel-heading {
      text-align: center;
      margin-bottom: 40px;
      font-size: 32px;
      font-weight: 600;
      color: #000;
    }
    .video-carousel-wrapper {
      display: flex;
      align-items: center;
      gap: 30px;
      justify-content: center;
    }
    .video-carousel-track {
      position: relative;
      width: 1240px;
      height: 430px;
      overflow: visible;
    }
    .video-carousel-item {
      position: absolute;
      width: 220px;
      height: 390px;
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      background: #000;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.5s ease;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .video-carousel-item.active {
      transform: translateX(-50%) scale(1.05);
      z-index: 5;
    }
    .video-carousel-item:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    .video-carousel-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
    }
    .video-carousel-play-btn {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      background: rgba(0,0,0,0.32);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .video-carousel-play-btn svg {
      width: 20px;
      height: 20px;
      margin-left: 3px;
    }
    .video-carousel-item:hover .video-carousel-play-btn {
      transform: translate(-50%, -50%) scale(1.1);
    }

    /* Product Overlay Styles */
    .video-carousel-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      padding: 10px;
      z-index: 3;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .video-carousel-item.active .video-carousel-overlay {
      opacity: 1;
    }
    .video-carousel-product {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #ECE5D4;
      padding: 8px;
      border-radius: 8px;
    }
    .video-carousel-product-image {
      width: 64px;
      height: 64px;
      border-radius: 4px;
      object-fit: cover;
    }
    .video-carousel-product-name {
      color: #39180FB2;
      font-size: 14px;
      display: flex;
      font-weight: 700;
      flex-direction: column;
      align-items: flex-start;
    }
    .video-carousel-shop-button {
      color: #333;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: underline;
      transition: all 0.3s ease;
    }

    .carousel-nav-btn {
      flex-shrink: 0;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(0,0,0,0.32);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      transition: background 0.2s ease, transform 0.2s ease;
      padding: 0 !important;
    }
    .carousel-nav-btn:hover {
      background: #fff;
      transform: scale(1.05);
    }
    .carousel-nav-btn:hover svg {
      stroke: #000;
    }
    .carousel-nav-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Modal Styles */
    .video-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .video-modal-overlay.active {
      display: flex;
    }
    .video-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      cursor: pointer;
      color: #fff;
      font-size: 30px;
      z-index: 10001;
      line-height: 1;
      padding: 0 !important;
    }
    .video-modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      max-width: 100%;
      position: relative;
    }
    .video-modal-main {
      width: 400px;
      max-width: 90vw;
      height: 710px;
      max-height: 80vh;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      background: #000;
    }
    .video-modal-main video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .video-modal-username {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      background: rgba(0,0,0,0.5);
      padding: 8px 15px;
      border-radius: 20px;
    }
    .video-modal-product-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      padding: 20px;
      z-index: 3;
    }
    .video-modal-product {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #ECE5D4;
      padding: 8px 20px 8px 8px;
      border-radius: 8px;
    }
    .video-modal-product-image {
      width: 64px;
      height: 64px;
      border-radius: 4px;
      object-fit: cover;
    }
    .video-modal-product-name {
      color: #39180FB2;
      font-size: 14px;
      display: flex;
      font-weight: 700;
      flex-direction: column;
      align-items: flex-start;
    }
    .video-modal-shop-button {
      color: #333;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: underline;
      transition: all 0.3s ease;
    }
    .video-modal-sound {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 35px;
      height: 35px;
      background: rgba(0,0,0,0.5);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 !important;
    }
    .modal-nav-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      cursor: pointer;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      padding: 0 !important;
    }
    .modal-nav-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .video-carousel-section {
        padding: 40px 0;
      }
      .video-carousel-container {
        padding: 0 !important;
      }
      .video-carousel-heading {
        font-size: 24px;
        margin-bottom: 30px;
      }
      .video-carousel-wrapper {
        gap: 0;
        position: relative;
      }
      .video-carousel-track {
        width: 100%;
        max-width: 100%;
        height: 340px;
        touch-action: pan-y;
      }
      .video-carousel-item {
        width: 180px;
        height: 320px;
        border-radius: 16px;
        top: 50%;
      }
      .video-carousel-item.active {
        transform: translateX(-50%) scale(1);
      }
      .video-carousel-play-btn {
        width: 45px;
        height: 45px;
      }
      .video-carousel-play-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Product Overlay Mobile Styles */
      .video-carousel-overlay {
        padding: 15px;
      }
      .video-carousel-product {
        gap: 8px;
        padding: 6px 15px 6px 6px;
      }
      .video-carousel-product-image {
        width: 50px;
        height: 50px;
      }
      .video-carousel-product-name {
        font-size: 12px;
      }
      .video-carousel-shop-button {
        font-size: 11px;
      }

      /* Modal Mobile Styles */
      .video-modal-overlay {
        padding: 0;
        align-items: stretch;
      }
      .video-modal-close {
        top: 15px;
        right: 15px;
        width: 40px;
        height: 40px;
        font-size: 28px;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .video-modal-content {
        flex-direction: column;
        gap: 0;
        width: 100%;
        height: 100%;
      }
      .video-modal-main {
        width: 100%;
        max-width: 100%;
        height: 100%;
        max-height: 100%;
        border-radius: 0;
      }
      .video-modal-username {
        bottom: 60px;
        left: 15px;
        font-size: 13px;
        padding: 6px 12px;
      }
      .video-modal-product-overlay {
        padding: 15px;
      }
      .video-modal-product {
        gap: 8px;
        padding: 6px 15px 6px 6px;
      }
      .video-modal-product-image {
        width: 50px;
        height: 50px;
      }
      .video-modal-product-name {
        font-size: 12px;
      }
      .video-modal-shop-button {
        font-size: 11px;
      }
      .video-modal-sound {
        top: 60px;
        right: 15px;
        width: 40px;
        height: 40px;
      }
      .modal-nav-btn.modal-prev{
        z-index: 1;
        left: 5%;
        position: absolute;
      }
      .modal-nav-btn.modal-next{
        z-index: 1;
        right: 5%;
        position: absolute;
      }
      .carousel-nav-btn.next{
        z-index: 111;
        right: 5%;
        position: absolute;
      }
      .carousel-nav-btn.prev{
        z-index: 111;
        left: 5%;
        position: absolute;
      }

    }

    /* Smaller mobile devices */
    @media (max-width: 480px) {
      .video-carousel-section {
        padding: 30px 0;
      }
      .video-carousel-heading {
        font-size: 20px;
        margin-bottom: 25px;
      }
      .video-carousel-track {
        height: 320px;
      }
      .video-carousel-item {
        width: 180px;
        height: 285px;
        border-radius: 14px;
      }
      .video-carousel-play-btn {
        width: 40px;
        height: 40px;
      }
      .video-carousel-play-btn svg {
        width: 16px;
        height: 16px;
      }
    }

    /* Landscape mobile orientation */
    @media (max-width: 768px) and (orientation: landscape) {
      .video-carousel-track {
        height: 300px;
      }
      .video-carousel-item {
        width: 180px;
        height: 250px;
      }
    }
  </style>

  <section class="video-carousel-section" data-section-id="{{ section.id }}">
    <div class="page-width video-carousel-container">
      {% if section.settings.heading != blank %}
        <h2 class="video-carousel-heading">{{ section.settings.heading }}</h2>
      {% endif %}

      <div class="video-carousel-wrapper">
        <button class="carousel-nav-btn prev" aria-label="Previous">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>

        <div class="video-carousel-track">
          {% comment %} Display block videos {% endcomment %}
          {% for block in section.blocks %}
            {% if block.settings.video %}
              <div
                class="video-carousel-item"
                data-index="{{ forloop.index0 }}"
                {% if block.settings.product != blank %}
                  data-product-title="{{ block.settings.product.title | escape }}"
                  data-product-url="{{ block.settings.product.url }}"
                  data-product-image="{{ block.settings.product.featured_image | image_url: width: 80 }}"
                {% endif %}
                {{ block.shopify_attributes }}
              >
                <video class="video-carousel-video" muted playsinline loop preload="auto">
                  <source src="{{ block.settings.video.sources[1].url }}" type="video/mp4">
                </video>
                <div class="video-carousel-play-btn">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22.7524 10.0499L3.86361 0.306386C2.30743 -0.489961 0 0.306386 0 2.22699V21.7141C0 23.4941 2.14645 24.5715 3.86361 23.6815L22.7524 13.938C24.4159 13.0479 24.4159 10.94 22.7524 10.0499Z" fill="#FCFCFC"/>
                  </svg>
                </div>

                {%- if block.settings.product != blank -%}
                  <div class="video-carousel-overlay">
                    <div class="video-carousel-product">
                      {%- if block.settings.product.featured_image != blank -%}
                        <img
                          src="{{ block.settings.product.featured_image | image_url: width: 80 }}"
                          alt="{{ block.settings.product.title | escape }}"
                          class="video-carousel-product-image"
                        >
                      {%- endif -%}
                      <span class="video-carousel-product-name">
                        {{ block.settings.product.title | truncate: 20 }}

                        <a href="{{ block.settings.product.url }}" class="video-carousel-shop-button">
                          Shop Now
                        </a>
                      </span>
                    </div>
                  </div>
                {%- endif -%}
              </div>
            {% endif %}
          {% endfor %}

          {% comment %} Display metafield videos if enabled {% endcomment %}
          {% if section.settings.use_metafields and product %}
            {% for i in (1..5) %}
              {% assign video_key = 'video_' | append: i %}
              {% assign metafield_video = product.metafields.custom[video_key] %}
              {% if metafield_video != blank %}
                <div
                  class="video-carousel-item"
                  data-index="metafield-{{ i }}"
                >
                  <video class="video-carousel-video" muted playsinline loop preload="auto">
                    <source src="{{ metafield_video.sources[1].url }}" type="video/mp4">
                  </video>
                  <div class="video-carousel-play-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M22.7524 10.0499L3.86361 0.306386C2.30743 -0.489961 0 0.306386 0 2.22699V21.7141C0 23.4941 2.14645 24.5715 3.86361 23.6815L22.7524 13.938C24.4159 13.0479 24.4159 10.94 22.7524 10.0499Z" fill="#FCFCFC"/>
                    </svg>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>

        <button class="carousel-nav-btn next" aria-label="Next">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Video Modal -->
    <div class="video-modal-overlay" id="videoModal-{{ section.id }}">
      <button class="video-modal-close" aria-label="Close">&times;</button>

      <div class="video-modal-content">
        <button class="modal-nav-btn modal-prev" aria-label="Previous">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>

        <div class="video-modal-main">
          <video id="modalVideo-{{ section.id }}" playsinline loop>
            <source src="" type="video/mp4">
          </video>
          <button class="video-modal-sound" aria-label="Toggle Sound">
            <svg class="sound-on" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
            </svg>
            <svg class="sound-off" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
              <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
            </svg>
          </button>
          <div class="video-modal-username"></div>
          <div class="video-modal-product-overlay" style="display:none;">
            <div class="video-modal-product">
              <img src="" alt="" class="video-modal-product-image">
              <span class="video-modal-product-name">
                <span class="product-title"></span>
                <a href="" class="video-modal-shop-button">Shop Now</a>
              </span>
            </div>
          </div>
        </div>

        <button class="modal-nav-btn modal-next" aria-label="Next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </div>
  </section>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!section) return;
  
  const track = section.querySelector('.video-carousel-track');
  const items = Array.from(section.querySelectorAll('.video-carousel-item'));
  const prevBtn = section.querySelector('.carousel-nav-btn.prev');
  const nextBtn = section.querySelector('.carousel-nav-btn.next');
  const modal = document.getElementById('videoModal-{{ section.id }}');
  const modalVideo = document.getElementById('modalVideo-{{ section.id }}');
  const modalClose = modal.querySelector('.video-modal-close');
  const modalPrev = modal.querySelector('.modal-prev');
  const modalNext = modal.querySelector('.modal-next');
  const modalUsername = modal.querySelector('.video-modal-username');
  const soundBtn = modal.querySelector('.video-modal-sound');
  const soundOn = soundBtn.querySelector('.sound-on');
  const soundOff = soundBtn.querySelector('.sound-off');
  
  if (items.length === 0) return;
  
  let currentIndex = 0;
  let autoplayInterval;
  const autoplaySpeed = {{ section.settings.autoplay_speed }} * 1000;
  let isMuted = false;
  
  const isMobile = window.innerWidth <= 768;
  const itemWidth = isMobile ? 180 : 220;
  const gap = isMobile ? 15 : 20;

  // Position items in carousel
  function updatePositions() {
    items.forEach((item, index) => {
      let position = index - currentIndex;

      // Normalize position for infinite loop
      if (position > items.length / 2) {
        position -= items.length;
      } else if (position < -items.length / 2) {
        position += items.length;
      }

      const translateX = position * (itemWidth + gap);

      // Show appropriate number of items based on screen size
      const visibleRange = isMobile ? 1 : 2;

      if (Math.abs(position) <= visibleRange) {
        // Mobile-specific styling for side items
        let scale = 1;
        let opacity = 1;
        
        if (isMobile && position !== 0) {
          scale = 0.85;
          opacity = 0.6;
        }

        item.style.opacity = opacity;
        item.style.visibility = 'visible';
        
        const centerScale = position === 0 ? (isMobile ? 1 : 1.05) : scale;
        
        item.style.transform = `translate(calc(-50% + ${translateX}px), -50%) scale(${centerScale})`;
        item.style.zIndex = 5 - Math.abs(position);

        // Make outer items (position -2 and +2) 50px shorter
        if (Math.abs(position) === 2) {
          item.style.height = isMobile ? '270px' : '340px';
        } else {
          item.style.height = isMobile ? '320px' : '390px';
        }

        if (position === 0) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      } else {
        item.style.opacity = '0';
        item.style.visibility = 'hidden';
        item.style.transform = `translate(calc(-50% + ${translateX}px), -50%)`;
        item.classList.remove('active');
      }
    });

    playActiveVideo();
  }

  // Play only center video
  function playActiveVideo() {
    items.forEach((item, index) => {
      const video = item.querySelector('video');
      if (video) {
        if (index === currentIndex) {
          video.currentTime = 0;
          video.play().catch(() => {});
        } else {
          video.pause();
        }
      }
    });
  }

  // Navigate to next
  function goToNext() {
    currentIndex = (currentIndex + 1) % items.length;
    updatePositions();
  }

  // Navigate to previous
  function goToPrev() {
    currentIndex = (currentIndex - 1 + items.length) % items.length;
    updatePositions();
  }

  // Button events
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      goToPrev();
      resetAutoplay();
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      goToNext();
      resetAutoplay();
    });
  }

  // Mobile swipe functionality
  let touchStartX = 0;
  let touchEndX = 0;
  
  track.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
  }, { passive: true });

  track.addEventListener('touchmove', (e) => {
    touchEndX = e.touches[0].clientX;
  }, { passive: true });

  track.addEventListener('touchend', () => {
    const diff = touchStartX - touchEndX;
    if (Math.abs(diff) > 50) {
      if (diff > 0) {
        goToNext();
      } else {
        goToPrev();
      }
      resetAutoplay();
    }
  });

  // Autoplay
  function startAutoplay() {
    autoplayInterval = setInterval(() => {
      goToNext();
    }, autoplaySpeed);
  }

  function resetAutoplay() {
    clearInterval(autoplayInterval);
    startAutoplay();
  }

  // Modal functions
  function openModal(index) {
    currentIndex = index;
    const item = items[index];
    const video = item.querySelector('video');

    if (video) {
      const videoSrc = video.querySelector('source').src;
      modalVideo.querySelector('source').src = videoSrc;
      modalVideo.load();
      modalVideo.muted = isMuted;
      modalVideo.play();
    }

    // Handle product overlay
    const modalProductOverlay = modal.querySelector('.video-modal-product-overlay');
    const productTitle = item.dataset.productTitle;
    const productUrl = item.dataset.productUrl;
    const productImage = item.dataset.productImage;

    if (productTitle && productUrl && productImage) {
      // Update product information
      modalProductOverlay.querySelector('.video-modal-product-image').src = productImage;
      modalProductOverlay.querySelector('.video-modal-product-image').alt = productTitle;
      modalProductOverlay.querySelector('.product-title').textContent = productTitle.length > 20 ? productTitle.substring(0, 20) + '...' : productTitle;
      modalProductOverlay.querySelector('.video-modal-shop-button').href = productUrl;
      modalProductOverlay.style.display = 'block';
    } else {
      modalProductOverlay.style.display = 'none';
    }

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    clearInterval(autoplayInterval);
  }

  function closeModal() {
    modal.classList.remove('active');
    modalVideo.pause();
    document.body.style.overflow = '';
    startAutoplay();
  }

  function navigateModal(direction) {
    let newIndex = currentIndex + direction;
    if (newIndex < 0) newIndex = items.length - 1;
    if (newIndex >= items.length) newIndex = 0;
    openModal(newIndex);
  }

  // Event listeners
  items.forEach((item, index) => {
    item.addEventListener('click', () => openModal(index));
  });

  modalClose.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  if (modalPrev) {
    modalPrev.addEventListener('click', () => navigateModal(-1));
  }
  
  if (modalNext) {
    modalNext.addEventListener('click', () => navigateModal(1));
  }

  soundBtn.addEventListener('click', () => {
    isMuted = !isMuted;
    modalVideo.muted = isMuted;
    soundOn.style.display = isMuted ? 'none' : 'block';
    soundOff.style.display = isMuted ? 'block' : 'none';
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!modal.classList.contains('active')) return;
    if (e.key === 'Escape') closeModal();
    if (e.key === 'ArrowLeft') navigateModal(-1);
    if (e.key === 'ArrowRight') navigateModal(1);
  });

  // Touch swipe for modal
  let modalTouchStartX = 0;
  modal.addEventListener('touchstart', (e) => {
    modalTouchStartX = e.touches[0].clientX;
  });

  modal.addEventListener('touchend', (e) => {
    const modalTouchEndX = e.changedTouches[0].clientX;
    const diff = modalTouchStartX - modalTouchEndX;
    if (Math.abs(diff) > 50) {
      navigateModal(diff > 0 ? 1 : -1);
    }
  });

  // Handle window resize - recalculate layout instead of reloading
  let resizeTimer;
  let lastWidth = window.innerWidth;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      // Only recalculate if width actually changed (ignore height changes from mobile address bar)
      if (Math.abs(window.innerWidth - lastWidth) > 50) {
        lastWidth = window.innerWidth;
        // Recalculate mobile state and update positions
        const newIsMobile = window.innerWidth <= 768;
        if (newIsMobile !== isMobile) {
          location.reload();
        }
      }
    }, 250);
  });

  // Initialize
  updatePositions();
  startAutoplay();
});
  </script>
{% endif %}
