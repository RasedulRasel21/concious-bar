<style>
  .loader {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  .cart-order__summary .quantity-selector__button {
    padding-inline-start: unset !important;
    padding-inline-end: unset !important;
  }

  /* Variety Pack Line Item Styles */

  .variety-pack-line-item .line-item__media-wrapper {
    width: 96px;
    min-width: 96px;
  }
  .variety-pack-line-item .line-item__media {
    width: 96px;
    height: 96px;
    object-fit: cover;
    border-radius: 4px;
  }
  .variety-pack-view-btn {
    color: #39180F;
    text-decoration: none;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    font-size: 13px;
    width: fit-content;
  }
  .variety-pack-view-btn:hover {
    opacity: 0.7;
  }

  /* Variety Pack Modal */
  #varietyPackModal {
    display: none;
    position: fixed;
    z-index: 10000;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #FDF8EE;
    border-radius: 12px;
    box-shadow: 0 4px 30px rgba(0,0,0,0.25);
    padding: 24px;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  }
  #varietyPackModal.active {
    display: block;
  }
  #varietyPackModal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(57, 24, 15, 0.15);
  }
  #varietyPackModal .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #39180F;
  }
  #varietyPackModal .modal-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    opacity: 0.6;
    transition: opacity 0.2s;
  }
  #varietyPackModal .modal-close:hover {
    opacity: 1;
  }
  #varietyPackModal .variety-items-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #varietyPackModal .variety-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
    border: 1px solid rgba(57, 24, 15, 0.1);
  }
  #varietyPackModal .variety-item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 6px;
  }
  #varietyPackModal .variety-item-info {
    flex: 1;
  }
  #varietyPackModal .variety-item-title {
    font-weight: 500;
    font-size: 14px;
    color: #39180F;
    margin: 0 0 4px 0;
  }
  #varietyPackModal .variety-item-price {
    font-size: 13px;
    color: #39180F;
    opacity: 0.7;
  }
  .variety-pack-modal-backdrop {
    display: none;
    position: fixed;
    z-index: 9999;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
  }
  .variety-pack-modal-backdrop.active {
    display: block;
  }
</style>
<div class="container">
  {%- if cart.item_count == 0 -%}
    <div class="empty-state">
      <div class="empty-state__icon-wrapper">
        {%- render 'icon' with 'cart', width: 32, height: 32, stroke_width: 1 -%}
        <span class="count-bubble count-bubble--lg">0</span>
      </div>

      <div class="prose">
        <p class="h4">{{ 'cart.general.empty' | t }}</p>

        {%- assign button_content = 'cart.general.continue_shopping' | t -%}
        {%- render 'button', href: settings.cart_empty_button_link, size: 'xl', content: button_content -%}
      </div>
    </div>
  {%- else -%}
    <div class="page-spacer">
      <div class="cart">
        <div class="cart-header">
          <h1 class="h2">{{ 'cart.general.title' | t }}</h1>

          {%- if settings.cart_show_free_shipping_threshold -%}
            {%- render 'free-shipping-bar' -%}
          {%- endif -%}
        </div>

        <div class="cart-order">
          <div class="cart-order__summary">
            {%- comment -%}
              ----------------------------------------------------------------------------------------------------------------
              ORDER SUMMARY
              ----------------------------------------------------------------------------------------------------------------
            {%- endcomment -%}
            <table class="order-summary">
              <thead class="order-summary__header">
                <tr>
                  <th>{{ 'customer.order.product' | t }}</th>
                  <th class="w-0">{{ 'customer.order.quantity' | t }}</th>
                  <th class="text-end">{{ 'customer.order.total' | t }}</th>
                </tr>
              </thead>

              <tbody class="order-summary__body">
                {%- comment -%} Group variety pack items by instance ID {%- endcomment -%}
                {%- assign variety_pack_instances = '' -%}
                {%- assign processed_variety_items = '' -%}

                {%- for line_item in cart.items -%}
                  {%- assign is_variety_pack_item = false -%}
                  {%- assign variety_instance_id = '' -%}

                  {%- for property in line_item.properties -%}
                    {%- if property.first == '_variety_pack' and property.last == 'true' -%}
                      {%- assign is_variety_pack_item = true -%}
                    {%- endif -%}
                    {%- if property.first == '_variety_pack_instance' -%}
                      {%- assign variety_instance_id = property.last -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- if is_variety_pack_item and variety_instance_id != '' -%}
                    {%- unless variety_pack_instances contains variety_instance_id -%}
                      {%- if variety_pack_instances != '' -%}
                        {%- assign variety_pack_instances = variety_pack_instances | append: ',' | append: variety_instance_id -%}
                      {%- else -%}
                        {%- assign variety_pack_instances = variety_instance_id -%}
                      {%- endif -%}

                      {%- comment -%} Get pack info from first item {%- endcomment -%}
                      {%- assign pack_name = '' -%}
                      {%- assign pack_image = '' -%}
                      {%- assign pack_items_count = 0 -%}
                      {%- assign pack_total_price = 0 -%}
                      {%- assign pack_line_keys = '' -%}
                      {%- assign pack_quantity = 1 -%}

                      {%- for item in cart.items -%}
                        {%- assign item_instance = '' -%}
                        {%- assign item_is_variety = false -%}
                        {%- for prop in item.properties -%}
                          {%- if prop.first == '_variety_pack_instance' and prop.last == variety_instance_id -%}
                            {%- assign item_instance = prop.last -%}
                          {%- endif -%}
                          {%- if prop.first == '_variety_pack' and prop.last == 'true' -%}
                            {%- assign item_is_variety = true -%}
                          {%- endif -%}
                          {%- if prop.first == '_variety_pack_name' -%}
                            {%- assign pack_name = prop.last -%}
                          {%- endif -%}
                          {%- if prop.first == '_variety_pack_image' -%}
                            {%- assign pack_image = prop.last -%}
                          {%- endif -%}
                        {%- endfor -%}

                        {%- if item_is_variety and item_instance == variety_instance_id -%}
                          {%- assign pack_items_count = pack_items_count | plus: 1 -%}
                          {%- assign pack_total_price = pack_total_price | plus: item.final_line_price -%}
                          {%- if pack_quantity == 1 -%}
                            {%- assign pack_quantity = item.quantity -%}
                          {%- endif -%}
                          {%- if pack_line_keys != '' -%}
                            {%- assign pack_line_keys = pack_line_keys | append: ',' | append: item.key -%}
                          {%- else -%}
                            {%- assign pack_line_keys = item.key -%}
                          {%- endif -%}
                        {%- endif -%}
                      {%- endfor -%}

                      {%- comment -%} Render variety pack custom line item {%- endcomment -%}
                      <tr class="variety-pack-line-item" data-variety-instance="{{ variety_instance_id }}" data-line-keys="{{ pack_line_keys }}">
                        <td colspan="3">
                          <div style="display: flex; gap: 16px; align-items: center;">
                            <div class="line-item__media-wrapper">
                              {%- if pack_image != '' -%}
                                <img src="{{ pack_image }}" alt="{{ pack_name }}" class="line-item__media" loading="lazy" width="96" height="96">
                              {%- endif -%}
                            </div>

                            <div style="flex: 1;">
                              <div class="v-stack gap-0.5">
                                <p class="bold">{{ pack_name }}</p>
                                <p class="text-sm text-subdued">{{ pack_items_count }} items included</p>
                                <button type="button" class="variety-pack-view-btn text-sm link" data-variety-instance="{{ variety_instance_id }}" onclick="openVarietyPackModal('{{ variety_instance_id }}')">
                                  Show variety products
                                </button>
                              </div>
                            </div>

                            <div class="text-center v-stack gap-2" style="min-width: 120px;">
                              <div class="quantity-selector h-stack gap-2 items-center justify-center">
                                <button type="button" class="quantity-selector__button quantity-minus" data-action="minus" data-variety-instance="{{ variety_instance_id }}" data-line-keys="{{ pack_line_keys }}" data-quantity="{{ pack_quantity }}" aria-label="Decrease quantity" {% if pack_quantity <= 1 %}disabled{% endif %}>
                                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="1" viewBox="0 0 12 1" fill="none">
                                    <path d="M12 0.5C12 0.632608 11.9473 0.759786 11.8536 0.853554C11.7598 0.947322 11.6326 1 11.5 1H0.5C0.367392 1 0.240215 0.947322 0.146447 0.853554C0.0526785 0.759786 0 0.632608 0 0.5C0 0.367392 0.0526785 0.240215 0.146447 0.146447C0.240215 0.0526785 0.367392 0 0.5 0H11.5C11.6326 0 11.7598 0.0526785 11.8536 0.146447C11.9473 0.240215 12 0.367392 12 0.5Z" fill="#39180F"></path>
                                  </svg>
                                </button>

                                <input class="quantity-input quantity-selector__input variety-pack-quantity-input" type="number" inputmode="numeric" min="1" step="1" data-variety-instance="{{ variety_instance_id }}" data-line-keys="{{ pack_line_keys }}" aria-label="Change quantity" value="{{ pack_quantity }}" data-current-quantity="{{ pack_quantity }}">

                                <button type="button" class="quantity-selector__button quantity-plus" data-action="plus" data-variety-instance="{{ variety_instance_id }}" data-line-keys="{{ pack_line_keys }}" data-quantity="{{ pack_quantity }}" aria-label="Increase quantity">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="13" viewBox="0 0 12 13" fill="none">
                                    <path d="M12 6.5C12 6.63261 11.9473 6.75979 11.8536 6.85355C11.7598 6.94732 11.6326 7 11.5 7H6.5V12C6.5 12.1326 6.44732 12.2598 6.35355 12.3536C6.25979 12.4473 6.13261 12.5 6 12.5C5.86739 12.5 5.74021 12.4473 5.64645 12.3536C5.55268 12.2598 5.5 12.1326 5.5 12V7H0.5C0.367392 7 0.240215 6.94732 0.146447 6.85355C0.0526785 6.75979 0 6.63261 0 6.5C0 6.36739 0.0526785 6.24021 0.146447 6.14645C0.240215 6.05268 0.367392 6 0.5 6H5.5V1C5.5 0.867392 5.55268 0.740215 5.64645 0.646447C5.74021 0.552679 5.86739 0.5 6 0.5C6.13261 0.5 6.25979 0.552679 6.35355 0.646447C6.44732 0.740215 6.5 0.867392 6.5 1V6H11.5C11.6326 6 11.7598 6.05268 11.8536 6.14645C11.9473 6.24021 12 6.36739 12 6.5Z" fill="#39180F"></path>
                                  </svg>
                                </button>
                              </div>

                              <span class="text-xs">
                                <a href="#" class="link remove-variety-pack" data-variety-instance="{{ variety_instance_id }}" data-line-keys="{{ pack_line_keys }}" aria-label="Remove variety pack">
                                  Remove
                                </a>
                              </span>
                            </div>

                            <div class="text-subdued text-end" style="min-width: 100px;">
                              <span class="variety-pack-total-price" data-variety-instance="{{ variety_instance_id }}">{{ pack_total_price | money }}</span>
                            </div>
                          </div>
                        </td>
                      </tr>
                    {%- endunless -%}
                    {%- assign processed_variety_items = processed_variety_items | append: line_item.key | append: ',' -%}
                  {%- else -%}
                    {% liquid
                      assign max_quantity = null

                      if line_item.variant.inventory_management != blank and line_item.variant.inventory_policy == 'deny'
                        assign current_quantity_for_variant = cart | item_count_for_variant: line_item.variant.id
                        assign max_quantity = line_item.variant.inventory_quantity | minus: current_quantity_for_variant | plus: line_item.quantity
                      endif

                      if line_item.variant.quantity_rule.max != null
                        assign max_quantity = max_quantity | default: 999999 | at_most: line_item.variant.quantity_rule.max
                      endif
                    %}

                    <tr>
                      <td>{%- render 'line-item', line_item: line_item -%}</td>

                      <td class="hidden align-center text-center text-subdued sm:table-cell">
                        <line-item-quantity class="v-stack gap-2">
                          <div class="quantity-selector h-stack gap-2 items-center justify-center">
                            <button
                              type="button"
                              class="quantity-selector__button quantity-minus"
                              data-action="minus"
                              data-line-key="{{ line_item.key }}"
                              data-quantity="{{ line_item.quantity }}"
                              aria-label="Decrease quantity"
                              {% if line_item.quantity <= line_item.variant.quantity_rule.min %}disabled{% endif %}
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="1" viewBox="0 0 12 1" fill="none">
                                <path d="M12 0.5C12 0.632608 11.9473 0.759786 11.8536 0.853554C11.7598 0.947322 11.6326 1 11.5 1H0.5C0.367392 1 0.240215 0.947322 0.146447 0.853554C0.0526785 0.759786 0 0.632608 0 0.5C0 0.367392 0.0526785 0.240215 0.146447 0.146447C0.240215 0.0526785 0.367392 0 0.5 0H11.5C11.6326 0 11.7598 0.0526785 11.8536 0.146447C11.9473 0.240215 12 0.367392 12 0.5Z" fill="#39180F"/>
                              </svg>
                            </button>

                            <input class="quantity-input quantity-selector__input" type="number" is="quantity-input" inputmode="numeric" min="{{ line_item.variant.quantity_rule.min }}" step="{{ line_item.variant.quantity_rule.increment }}" {% if max_quantity != null %}max="{{ max_quantity }}"{% endif %} data-line-key="{{ line_item.key }}" aria-label="{{ 'cart.order.change_quantity' | t | escape }}" value="{{ line_item.quantity }}">

                            <button
                              type="button"
                              class="quantity-selector__button quantity-plus"
                              data-action="plus"
                              data-line-key="{{ line_item.key }}"
                              data-quantity="{{ line_item.quantity }}"
                              aria-label="Increase quantity"
                              {% if max_quantity != null and line_item.quantity >= max_quantity %}disabled{% endif %}
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="13" viewBox="0 0 12 13" fill="none">
                                <path d="M12 6.5C12 6.63261 11.9473 6.75979 11.8536 6.85355C11.7598 6.94732 11.6326 7 11.5 7H6.5V12C6.5 12.1326 6.44732 12.2598 6.35355 12.3536C6.25979 12.4473 6.13261 12.5 6 12.5C5.86739 12.5 5.74021 12.4473 5.64645 12.3536C5.55268 12.2598 5.5 12.1326 5.5 12V7H0.5C0.367392 7 0.240215 6.94732 0.146447 6.85355C0.0526785 6.75979 0 6.63261 0 6.5C0 6.36739 0.0526785 6.24021 0.146447 6.14645C0.240215 6.05268 0.367392 6 0.5 6H5.5V1C5.5 0.867392 5.55268 0.740215 5.64645 0.646447C5.74021 0.552679 5.86739 0.5 6 0.5C6.13261 0.5 6.25979 0.552679 6.35355 0.646447C6.44732 0.740215 6.5 0.867392 6.5 1V6H11.5C11.6326 6 11.7598 6.05268 11.8536 6.14645C11.9473 6.24021 12 6.36739 12 6.5Z" fill="#39180F"/>
                              </svg>
                            </button>
                          </div>

                          <span class="text-xs">
                            <a
                              href="#"
                              class="link remove-single-item"
                              data-line-key="{{ line_item.key }}"
                              aria-label="{{ 'cart.order.remove_with_title' | t: title: line_item.title | escape }}"
                            >
                              {{- 'cart.order.remove' | t -}}
                            </a>
                          </span>
                        </line-item-quantity>
                      </td>

                      <td class="hidden align-center text-subdued text-end sm:table-cell">
                        <span class="line-item-total" data-line-key="{{ line_item.key }}">{{ line_item.final_line_price | money }}</span>
                      </td>
                    </tr>
                  {%- endif -%}
                {%- endfor -%}
              </tbody>
            </table>

            {%- comment -%}
              ----------------------------------------------------------------------------------------------------------------
              SHIPPING ESTIMATOR
              ----------------------------------------------------------------------------------------------------------------
            {%- endcomment -%}

            {%- if section.settings.show_shipping_estimator and cart.requires_shipping -%}
              {%- assign accordion_title = 'cart.shipping_estimator.estimate_shipping' | t -%}
              {%- capture accordion_content -%}{%- render 'shipping-estimator' -%}{%- endcapture -%}

              {%- render 'accordion',
                title: accordion_title,
                icon: 'picto-box',
                content: accordion_content,
                size: 'lg'
              -%}
            {%- endif -%}
          </div>

          <safe-sticky class="cart-order__recap v-stack gap-6">
            <form action="{{ routes.cart_url }}" method="POST" class="cart-form rounded">
              {%- for block in section.blocks -%}
                {%- case block.type -%}
                  {%- when '@app' -%}
                    {%- render block -%}

                  {%- when 'totals' -%}
                    <div class="cart-form__totals v-stack gap-2" {{ block.shopify_attributes }}>
                      {%- if block.settings.show_order_weight -%}
                        <div class="h-stack gap-4 justify-between">
                          <span class="text-subdued">{{ 'cart.general.weight' | t }}</span>
                          <span class="text-subdued">{{ cart.total_weight | weight_with_unit }}</span>
                        </div>
                      {%- endif -%}

                      <div class="h-stack gap-4 justify-between">
                        <span class="text-subdued">{{ 'cart.general.subtotal' | t }}</span>
                        <span class="text-subdued">{{ cart.items_subtotal_price | money }}</span>
                      </div>

                      {% for discount_application in cart.cart_level_discount_applications %}
                        <div class="h-stack gap-4 justify-between">
                          <div class="badge">
                            {%- render 'icon' with 'discount' -%}
                            {{- discount_application.title -}}
                          </div>

                          <span class="text-subdued">-{{ discount_application.total_allocated_amount | money }}</span>
                        </div>
                      {% endfor %}

                      <div class="h-stack gap-4 justify-between">
                        <span class="h5">{{ 'cart.general.total' | t }}</span>
                        <span class="h5">{{- cart.total_price | money_with_currency -}}</span>
                      </div>
                      <span class="text-subdued text-sm">After all applied coupons & promotions</span>

                      {%- if block.settings.show_shipping_text -%}
                        {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
                          <span class="text-subdued text-sm">
                            {{-
                              'cart.general.taxes_included_and_shipping_policy_html'
                              | t: link: shop.shipping_policy.url
                            -}}
                          </span>
                        {%- elsif cart.taxes_included -%}
                          <span class="text-subdued text-sm">
                            {{- 'cart.general.taxes_included_but_shipping_at_checkout' | t -}}
                          </span>
                        {%- elsif shop.shipping_policy.body != blank -%}
                          <span class="text-subdued text-sm">
                            {{-
                              'cart.general.taxes_and_shipping_policy_at_checkout_html'
                              | t: link: shop.shipping_policy.url
                            -}}
                          </span>
                        {%- else -%}
                          <span class="text-subdued text-sm">
                            {{- 'cart.general.taxes_and_shipping_at_checkout' | t -}}
                          </span>
                        {%- endif -%}
                      {%- endif -%}
                    </div>

                  {%- when 'cart_note' -%}
                    <cart-note class="cart-form__note block" {{ block.shopify_attributes }}>
                      {%- assign order_note = 'cart.general.order_note' | t -%}
                      {%- render 'input',
                        name: 'note',
                        multiline: 3,
                        label: order_note,
                        value: cart.note,
                        maxlength: block.settings.maxlength
                      -%}
                    </cart-note>

                  {%- when 'text' -%}
                    {%- if block.settings.content != blank -%}
                      <div class="prose text-subdued" {{ block.shopify_attributes }}>
                        {{- block.settings.content -}}
                      </div>
                    {%- endif -%}

                  {%- when 'offer' -%}
                    {%- assign previous_block_index = forloop.index0 | minus: 1 -%}
                    {%- assign next_block_index = forloop.index0 | plus: 1 -%}

                    {%- if section.blocks[next_block_index].type == 'offer' -%}
                      <div class="v-stack gap-4">
                    {%- endif -%}

                    {%- render 'offer', block: block -%}

                    {%- if section.blocks[previous_block_index].type == 'offer' -%}
                      </div>
                    {%- endif -%}

                  {%- when 'accelerated_buttons' -%}
                    {% if additional_checkout_buttons %}
                      <div
                        class="additional-checkout-buttons additional-checkout-buttons--vertical"
                        {{ block.shopify_attributes }}
                      >
                        {{- content_for_additional_checkout_buttons -}}
                      </div>
                    {% endif %}

                  {%- when 'checkout_button' -%}
                    {%- assign checkout_button = 'cart.general.checkout' | t -%}
                    <div id="checkoutWrapper">
                      <p id="moq_text" class="text-subdued text-sm" style="padding-bottom: 6px;">
                        Must have at least $35 total.
                      </p>
                      <div id="cart_page_CheckoutBtn" style="pointer-events: none; ">
                        {%- render 'button',
                          type: 'submit',
                          icon: 'picto-lock',
                          content: checkout_button,
                          size: 'xl',
                          name: 'checkout',
                          stretch: true,
                          block: block
                        -%}
                      </div>
                    </div>
                {%- endcase -%}
              {%- endfor -%}
            </form>

            {%- if section.settings.show_payment_icons and shop.enabled_payment_types.size > 0 -%}
              <div class="v-stack gap-4">
                <span class="text-xs text-subdued text-center">{{ 'cart.general.we_accept' | t }}</span>

                <ul class="h-stack gap-2 wrap justify-center">
                  {%- for type in shop.enabled_payment_types -%}
                    <li class="contents">{{ type | payment_type_svg_tag }}</li>
                  {%- endfor -%}
                </ul>
              </div>
            {%- endif -%}
          </safe-sticky>
        </div>
      </div>
    </div>
  {%- endif -%}
</div>

<!-- Variety Pack Modal -->
<div id="varietyPackModalBackdrop" class="variety-pack-modal-backdrop" onclick="closeVarietyPackModal()"></div>
<div id="varietyPackModal">
  <div class="modal-header">
    <h3 id="varietyPackModalTitle">Variety Pack</h3>
    <button type="button" class="modal-close" onclick="closeVarietyPackModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 10 10" fill="none">
        <path d="M8.77201 1.22867L1.22934 8.77133M8.77201 8.77133L1.22934 1.22867" stroke="#39180F" stroke-width="1.5"/>
      </svg>
    </button>
  </div>
  <div id="varietyPackItemsList" class="variety-items-list">
    <!-- Items will be loaded dynamically -->
  </div>
</div>

<script>
// Wait for jQuery to be available
(function checkJQuery() {
  if (typeof jQuery !== 'undefined') {
    initCartPage();
  } else {
    setTimeout(checkJQuery, 50);
  }
})();

function initCartPage() {
  $(document).ready(function () {
    const $btnWrapper = $('#cart_page_CheckoutBtn button');

    // Add a loader span inside the button
    const originalBtnText = $btnWrapper.text();
    $btnWrapper
      .html(`<span class="loader" style="margin-right: 8px;"></span><span class="btn-text">${originalBtnText}</span>`)
      .css({
        'background-color': 'lightgray',
      });

  // Fetch cart and update button state
  fetch('/cart.js')
    .then(res => res.json())
    .then(cart => {
      console.log('Cart items:', cart.items);
      console.log('Total items:', cart.items.length);

      // Calculate total using original_line_price (before discounts)
      // This ensures all items including variety pack items are counted
      const cartTotal = cart.items.reduce((sum, item) => {
        console.log(`Item: ${item.product_title}, Line Price: ${item.line_price}, Original: ${item.original_line_price}`);
        return sum + item.original_line_price;
      }, 0) / 100;

      console.log('Cart Total:', cartTotal);

      if (cartTotal >= 35) {
        console.log('Cart meets minimum, enabling checkout');
        $('#moq_text').hide();
        $('#cart_page_CheckoutBtn').css('pointer-events', 'auto');
        $('#cartdrawer_checkoutBtn').css('pointer-events', 'auto');
        $btnWrapper.css('background-color', '');
      } else {
        console.log('Cart below minimum, showing warning');
        $btnWrapper.css('background-color', 'darkgray');
      }

      // Restore original button text and remove loader
      $btnWrapper.html(originalBtnText);
    })
    .catch(err => {
      console.error('Error fetching cart:', err);
      $btnWrapper.html(originalBtnText);
    });

  // Variety Pack Modal Functions
  window.openVarietyPackModal = async function(instanceId) {
    const modal = document.getElementById('varietyPackModal');
    const backdrop = document.getElementById('varietyPackModalBackdrop');
    const itemsList = document.getElementById('varietyPackItemsList');
    const modalTitle = document.getElementById('varietyPackModalTitle');

    if (!modal || !itemsList) return;

    // Show loading state
    itemsList.innerHTML = '<p style="text-align: center; padding: 20px;">Loading...</p>';
    modal.classList.add('active');
    backdrop.classList.add('active');

    try {
      // Fetch current cart
      const cartResponse = await fetch('/cart.js');
      const cart = await cartResponse.json();

      // Find items belonging to this variety pack instance
      const varietyItems = cart.items.filter(item => {
        return item.properties &&
               item.properties['_variety_pack'] === 'true' &&
               item.properties['_variety_pack_instance'] === instanceId;
      });

      if (varietyItems.length > 0) {
        // Get pack name from first item
        const packName = varietyItems[0].properties['_variety_pack_name'] || 'Variety Pack';
        modalTitle.textContent = packName;

        // Render items
        itemsList.innerHTML = varietyItems.map(item => `
          <div class="variety-item">
            <img src="${item.image || ''}" alt="${item.product_title}" onerror="this.style.display='none'">
            <div class="variety-item-info">
              <p class="variety-item-title">${item.product_title}</p>
              <p class="variety-item-price">${item.variant_title ? item.variant_title + ' - ' : ''}${typeof Shopify !== 'undefined' && Shopify.formatMoney ? Shopify.formatMoney(item.final_line_price) : '$' + (item.final_line_price / 100).toFixed(2)}</p>
            </div>
          </div>
        `).join('');
      } else {
        itemsList.innerHTML = '<p style="text-align: center; padding: 20px;">No items found</p>';
      }
    } catch (error) {
      console.error('Error loading variety pack items:', error);
      itemsList.innerHTML = '<p style="text-align: center; padding: 20px;">Error loading items</p>';
    }
  };

  window.closeVarietyPackModal = function() {
    const modal = document.getElementById('varietyPackModal');
    const backdrop = document.getElementById('varietyPackModalBackdrop');
    if (modal) modal.classList.remove('active');
    if (backdrop) backdrop.classList.remove('active');
  };

  // Handle variety pack quantity changes
  window.updateVarietyPackQuantity = async function(instanceId, lineKeys, newQuantity) {
    const lineItem = document.querySelector(`.variety-pack-line-item[data-variety-instance="${instanceId}"]`);
    if (!lineItem) return;

    const keys = lineKeys.split(',');

    try {
      // Build updates object to set all items to new quantity
      const updates = {};
      keys.forEach(key => {
        updates[key] = newQuantity;
      });

      const formData = new FormData();
      Object.keys(updates).forEach(key => {
        formData.set(`updates[${key}]`, updates[key]);
      });

      const response = await fetch('/cart/update.js', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const cart = await response.json();

        // Update the UI
        const quantityInput = lineItem.querySelector('.variety-pack-quantity-input');
        const minusButton = lineItem.querySelector('.quantity-minus');
        const plusButton = lineItem.querySelector('.quantity-plus');

        if (quantityInput) {
          quantityInput.value = newQuantity;
          quantityInput.dataset.currentQuantity = newQuantity;
        }

        if (minusButton) {
          minusButton.dataset.quantity = newQuantity;
          if (newQuantity <= 1) {
            minusButton.setAttribute('disabled', '');
          } else {
            minusButton.removeAttribute('disabled');
          }
        }

        if (plusButton) {
          plusButton.dataset.quantity = newQuantity;
        }

        // Update total price for the variety pack
        const priceElement = lineItem.querySelector('.variety-pack-total-price');
        if (priceElement) {
          let totalPrice = 0;
          cart.items.forEach(item => {
            if (item.properties &&
                item.properties['_variety_pack'] === 'true' &&
                item.properties['_variety_pack_instance'] === instanceId) {
              totalPrice += item.final_line_price;
            }
          });
          if (typeof Shopify !== 'undefined' && Shopify.formatMoney) {
            priceElement.textContent = Shopify.formatMoney(totalPrice);
          } else {
            priceElement.textContent = '$' + (totalPrice / 100).toFixed(2);
          }
        }

        // Update cart totals
        updateCartTotals(cart);
      }
    } catch (error) {
      console.error('Error updating variety pack quantity:', error);
    }
  };

  // Event listeners for variety pack quantity buttons
  document.addEventListener('click', function(e) {
    // Find if we clicked a quantity button (could be button, svg, or path inside button)
    let button = e.target.closest('.quantity-selector__button');

    if (!button) return;

    // Check if this button is inside a variety pack line item
    const varietyPackItem = button.closest('.variety-pack-line-item');
    if (!varietyPackItem) return;

    // Make sure this button has variety pack data attributes
    if (!button.hasAttribute('data-variety-instance')) return;

    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation(); // Stop all other handlers

    console.log('Variety pack quantity button clicked');

    const instanceId = button.getAttribute('data-variety-instance');
    const lineKeys = button.getAttribute('data-line-keys');
    const currentQuantity = parseInt(button.getAttribute('data-quantity')) || 1;
    const action = button.getAttribute('data-action');

    console.log('Instance ID:', instanceId);
    console.log('Line Keys:', lineKeys);
    console.log('Current Quantity:', currentQuantity);
    console.log('Action:', action);

    let newQuantity = currentQuantity;
    if (action === 'plus') {
      newQuantity = currentQuantity + 1;
    } else if (action === 'minus' && currentQuantity > 1) {
      newQuantity = currentQuantity - 1;
    }

    console.log('New Quantity:', newQuantity);

    if (newQuantity !== currentQuantity) {
      updateVarietyPackQuantity(instanceId, lineKeys, newQuantity);
    }
  }, true); // Use capture phase to run before other handlers

  // Event listener for variety pack quantity input changes
  document.addEventListener('change', function(e) {
    if (!e.target.classList.contains('variety-pack-quantity-input')) return;

    const input = e.target;
    const instanceId = input.dataset.varietyInstance;
    const lineKeys = input.dataset.lineKeys;
    const currentQuantity = parseInt(input.dataset.currentQuantity) || 1;
    let newQuantity = parseInt(input.value) || 1;

    // Ensure minimum quantity is 1
    if (newQuantity < 1) {
      newQuantity = 1;
      input.value = newQuantity;
    }

    if (newQuantity !== currentQuantity) {
      updateVarietyPackQuantity(instanceId, lineKeys, newQuantity);
    }
  });

  // Handle remove variety pack with double-click protection
  let isRemovingPack = false;
  const removedPacks = new Set();

  document.addEventListener('click', function(e) {
    // Check if the clicked element or its parent is the remove button
    let target = e.target;
    if (!target.classList.contains('remove-variety-pack')) {
      target = e.target.closest('.remove-variety-pack');
    }

    if (!target) return;

    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation(); // Prevent other handlers

    const instanceId = target.getAttribute('data-variety-instance');

    // Prevent double-click
    if (isRemovingPack || removedPacks.has(instanceId)) {
      console.log('Already removing a variety pack, ignoring click');
      return;
    }

    console.log('Remove variety pack clicked');
    console.log('Target:', target);
    console.log('Dataset:', target.dataset);

    const lineKeys = target.getAttribute('data-line-keys');

    console.log('Instance ID:', instanceId);
    console.log('Line Keys:', lineKeys);

    if (!lineKeys) {
      console.error('No line keys found');
      return;
    }

    // Set flags to prevent double-click
    isRemovingPack = true;
    removedPacks.add(instanceId);

    // Disable the button visually
    target.style.opacity = '0.5';
    target.style.pointerEvents = 'none';
    target.textContent = 'Removing...';

    const keys = lineKeys.split(',');
    console.log('Keys to remove:', keys);

    // Build updates object to set all items to 0
    const updates = {};
    keys.forEach(key => {
      updates[key] = 0;
    });

    console.log('Updates object:', updates);

    const formData = new FormData();
    Object.keys(updates).forEach(key => {
      formData.set(`updates[${key}]`, updates[key]);
    });

    console.log('Sending remove request...');

    fetch('/cart/update.js', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      console.log('Response status:', response.status);
      return response.json();
    })
    .then(cart => {
      console.log('Cart updated successfully:', cart);
      // Reload the page to show updated cart
      window.location.reload();
    })
    .catch(error => {
      console.error('Error removing variety pack:', error);
      alert('Error removing variety pack. Please try again.');
      // Reset flags on error
      isRemovingPack = false;
      removedPacks.delete(instanceId);
      target.style.opacity = '';
      target.style.pointerEvents = '';
      target.textContent = 'Remove';
    });
  }, true); // Use capture phase

  // Handle remove single item with double-click protection
  let isRemoving = false;
  const removedButtons = new Set();

  document.addEventListener('click', async function(e) {
    // Check if the clicked element or its parent is the remove button
    let target = e.target;
    if (!target.classList.contains('remove-single-item')) {
      target = e.target.closest('.remove-single-item');
    }

    if (!target) return;

    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation(); // Prevent other handlers

    // Prevent double-click: Check if we're already removing something
    if (isRemoving) {
      console.log('Already removing an item, ignoring click');
      return;
    }

    const lineKey = target.getAttribute('data-line-key');

    // Check if this specific button was already clicked
    if (removedButtons.has(lineKey)) {
      console.log('This item is already being removed, ignoring click');
      return;
    }

    console.log('Remove single item clicked');
    console.log('Line Key:', lineKey);

    if (!lineKey) {
      console.error('No line key found');
      return;
    }

    // Set flags to prevent double-click
    isRemoving = true;
    removedButtons.add(lineKey);

    // Disable the button visually
    target.style.opacity = '0.5';
    target.style.pointerEvents = 'none';
    target.textContent = 'Removing...';

    // First, verify this is not a variety pack item
    try {
      const cartResponse = await fetch('/cart.js');
      const cart = await cartResponse.json();

      const itemToRemove = cart.items.find(item => item.key === lineKey);

      if (itemToRemove && itemToRemove.properties && itemToRemove.properties['_variety_pack'] === 'true') {
        console.error('Cannot remove variety pack items individually. Remove the entire pack instead.');
        alert('This item is part of a variety pack. Please remove the entire pack instead.');

        // Reset flags
        isRemoving = false;
        removedButtons.delete(lineKey);
        target.style.opacity = '';
        target.style.pointerEvents = '';
        target.textContent = 'Remove';
        return;
      }
    } catch (error) {
      console.error('Error checking item:', error);
      isRemoving = false;
      removedButtons.delete(lineKey);
      target.style.opacity = '';
      target.style.pointerEvents = '';
      return;
    }

    const formData = new FormData();
    formData.set(`updates[${lineKey}]`, 0);

    console.log('Sending remove request for single item...');

    fetch('/cart/update.js', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      console.log('Response status:', response.status);
      return response.json();
    })
    .then(cart => {
      console.log('Cart updated successfully:', cart);
      // Reload the page to show updated cart
      window.location.reload();
    })
    .catch(error => {
      console.error('Error removing item:', error);
      alert('Error removing item. Please try again.');
      // Reset flags on error
      isRemoving = false;
      removedButtons.delete(lineKey);
      target.style.opacity = '';
      target.style.pointerEvents = '';
    });
  }, true); // Use capture phase

  // Helper function to update cart totals
  function updateCartTotals(cart) {
    // Update cart total
    const totalElement = document.querySelector('.cart-form__totals .h5:last-of-type');
    if (totalElement && typeof Shopify !== 'undefined' && Shopify.formatMoney) {
      totalElement.textContent = Shopify.formatMoney(cart.total_price, Shopify.money_format) + ' USD';
    }

    // Update subtotal
    const subtotalElement = document.querySelector('.cart-form__totals .text-subdued');
    if (subtotalElement && typeof Shopify !== 'undefined' && Shopify.formatMoney) {
      subtotalElement.textContent = Shopify.formatMoney(cart.items_subtotal_price);
    }

    // Reload the page to update everything properly
    setTimeout(() => {
      window.location.reload();
    }, 500);
  }

  }); // End $(document).ready
} // End initCartPage
</script>
{% schema %}
{
  "name": "Cart",
  "class": "shopify-section--main-cart",
  "tag": "section",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "totals",
      "name": "Totals",
      "limit": 1,
      "settings": [
        {
          "type": "checkbox",
          "id": "show_order_weight",
          "label": "Show order weight",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_shipping_text",
          "label": "Show shipping/taxes text",
          "default": true
        }
      ]
    },
    {
      "type": "cart_note",
      "name": "Cart note",
      "limit": 1,
      "settings": [
        {
          "type": "number",
          "id": "max_length",
          "label": "Maximum number of characters"
        }
      ]
    },
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "richtext",
          "id": "content",
          "label": "Content"
        }
      ]
    },
    {
      "type": "checkout_button",
      "name": "Checkout button",
      "limit": 1
    },
    {
      "type": "accelerated_buttons",
      "name": "Accelerated buttons",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "Configure accelerated payment buttons in your [payment settings](https://www.shopify.com/admin/settings/payments)."
        }
      ]
    },
    {
      "type": "offer",
      "name": "Offer",
      "limit": 2,
      "settings": [
        {
          "type": "select",
          "id": "text_alignment",
          "label": "Text alignment",
          "options": [
            {
              "value": "start",
              "label": "Left"
            },
            {
              "value": "center",
              "label": "Center"
            }
          ],
          "default": "start"
        },
        {
          "type": "select",
          "id": "icon_position",
          "label": "Icon position",
          "options": [
            {
              "value": "aligned",
              "label": "Aligned horizontally"
            },
            {
              "value": "stacked",
              "label": "Stacked"
            }
          ],
          "default": "aligned"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "picto-coupon",
              "label": "Coupon",
              "group": "Shop"
            },
            {
              "value": "picto-percent",
              "label": "Percent",
              "group": "Shop"
            },
            {
              "value": "picto-gift",
              "label": "Gift",
              "group": "Shop"
            },
            {
              "value": "picto-star",
              "label": "Star",
              "group": "Shop"
            },
            {
              "value": "picto-like",
              "label": "Like",
              "group": "Shop"
            },
            {
              "value": "picto-building",
              "label": "Building",
              "group": "Shop"
            },
            {
              "value": "picto-love",
              "label": "Love",
              "group": "Shop"
            },
            {
              "value": "picto-award-gift",
              "label": "Award gift",
              "group": "Shop"
            },
            {
              "value": "picto-happy",
              "label": "Happy",
              "group": "Shop"
            },
            {
              "value": "picto-box",
              "label": "Box",
              "group": "Shipping"
            },
            {
              "value": "picto-pin",
              "label": "Pin",
              "group": "Shipping"
            },
            {
              "value": "picto-timer",
              "label": "Timer",
              "group": "Shipping"
            },
            {
              "value": "picto-validation",
              "label": "Validation",
              "group": "Shipping"
            },
            {
              "value": "picto-truck",
              "label": "Truck",
              "group": "Shipping"
            },
            {
              "value": "picto-return",
              "label": "Return",
              "group": "Shipping"
            },
            {
              "value": "picto-earth",
              "label": "Earth",
              "group": "Shipping"
            },
            {
              "value": "picto-plane",
              "label": "Plane",
              "group": "Shipping"
            },
            {
              "value": "picto-credit-card",
              "label": "Credit card",
              "group": "Payment & Security"
            },
            {
              "value": "picto-lock",
              "label": "Lock",
              "group": "Payment & Security"
            },
            {
              "value": "picto-shield",
              "label": "Shield",
              "group": "Payment & Security"
            },
            {
              "value": "picto-secure-profile",
              "label": "Secure profile",
              "group": "Payment & Security"
            },
            {
              "value": "picto-money",
              "label": "Money",
              "group": "Payment & Security"
            },
            {
              "value": "picto-recycle",
              "label": "Recycle",
              "group": "Ecology"
            },
            {
              "value": "picto-leaf",
              "label": "Leaf",
              "group": "Ecology"
            },
            {
              "value": "picto-tree",
              "label": "Tree",
              "group": "Ecology"
            },
            {
              "value": "picto-mobile-phone",
              "label": "Mobile phone",
              "group": "Communication"
            },
            {
              "value": "picto-phone",
              "label": "Phone",
              "group": "Communication"
            },
            {
              "value": "picto-chat",
              "label": "Chat",
              "group": "Communication"
            },
            {
              "value": "picto-customer-support",
              "label": "Customer support",
              "group": "Communication"
            },
            {
              "value": "picto-operator",
              "label": "Operator",
              "group": "Communication"
            },
            {
              "value": "picto-mailbox",
              "label": "Mailbox",
              "group": "Communication"
            },
            {
              "value": "picto-envelope",
              "label": "Envelope",
              "group": "Communication"
            },
            {
              "value": "picto-comment",
              "label": "Comment",
              "group": "Communication"
            },
            {
              "value": "picto-question",
              "label": "Question",
              "group": "Communication"
            },
            {
              "value": "picto-send",
              "label": "Send",
              "group": "Communication"
            },
            {
              "value": "picto-at-sign",
              "label": "At sign",
              "group": "Tech"
            },
            {
              "value": "picto-camera",
              "label": "Camera",
              "group": "Tech"
            },
            {
              "value": "picto-wifi",
              "label": "WiFi",
              "group": "Tech"
            },
            {
              "value": "picto-bluetooth",
              "label": "Bluetooth",
              "group": "Tech"
            },
            {
              "value": "picto-printer",
              "label": "Printer",
              "group": "Tech"
            },
            {
              "value": "picto-smart-watch",
              "label": "Smart watch",
              "group": "Tech"
            },
            {
              "value": "picto-coffee",
              "label": "Coffee",
              "group": "Food & Drink"
            },
            {
              "value": "picto-burger",
              "label": "Burger",
              "group": "Food & Drink"
            },
            {
              "value": "picto-beer",
              "label": "Beer",
              "group": "Food & Drink"
            },
            {
              "value": "picto-target",
              "label": "Target",
              "group": "Other"
            },
            {
              "value": "picto-document",
              "label": "Document",
              "group": "Other"
            },
            {
              "value": "picto-jewelry",
              "label": "Jewelry",
              "group": "Other"
            },
            {
              "value": "picto-music",
              "label": "Music",
              "group": "Other"
            },
            {
              "value": "picto-file",
              "label": "File",
              "group": "Other"
            },
            {
              "value": "picto-mask",
              "label": "Mask",
              "group": "Other"
            },
            {
              "value": "picto-stop",
              "label": "Stop",
              "group": "Other"
            }
          ],
          "default": "picto-coupon"
        },
        {
          "type": "image_picker",
          "id": "custom_icon",
          "label": "Custom icon",
          "info": "240 x 240px .png recommended"
        },
        {
          "type": "range",
          "id": "icon_width",
          "min": 20,
          "max": 100,
          "step": 4,
          "unit": "px",
          "label": "Icon width",
          "default": 24
        },
        {
          "type": "text",
          "id": "title",
          "label": "Heading",
          "default": "Shipping"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Short content about your shipping rates or discounts.</p>"
        },
        {
          "type": "color",
          "id": "background",
          "label": "Background"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "checkbox",
      "id": "show_shipping_estimator",
      "label": "Show shipping estimator",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_payment_icons",
      "label": "Show payment icons",
      "default": true
    }
  ]
}
{% endschema %}
